name: Release

on:
  # 仅在推送版本 Tag 时发布，例如 v1.0.0
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: 安装依赖
        run: npm install

      - name: 类型检查
        run: npm run typecheck

      - name: 构建
        run: npm run build

      - name: 打包发布产物
        id: pack
        run: |
          VERSION="${GITHUB_REF_NAME}"
          ARTIFACT="yuuka-${VERSION}-build.tar.gz"
          tar -czf "${ARTIFACT}" dist cli.cjs package.json README.md README.zh-CN.md LICENSE yoga.wasm
          echo "artifact=${ARTIFACT}" >> "$GITHUB_OUTPUT"

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: ${{ steps.pack.outputs.artifact }}
          body: |
            自动发布（Tag 触发）
            - Tag: `${{ github.ref_name }}`
            - Commit: `${{ github.sha }}`
